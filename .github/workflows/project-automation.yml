name: Project Automation for BluePhysioVision
on:
  issues:
    types: [assigned, opened]
  create:
  pull_request:
    types: [opened, reopened, closed]
    
permissions:
  repository-projects: write
  issues: write
  pull-requests: write
  contents: read

env:
  ORGANIZATION: BluePhysioVision
  PROJECT_ID: 1
  
jobs:
  issue_opened:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Move New Issue to Backlog
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_PAT) }}
          organization: ${{ env.ORGANIZATION }}
          project_id: ${{ env.PROJECT_ID }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: "â€‹ðŸ“‹ Backlog"

  issue_assigned:
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    runs-on: ubuntu-latest
    steps:
      - name: Move Issue to Ready for Dev
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_PAT) }}
          organization: ${{ env.ORGANIZATION }}
          project_id: ${{ env.PROJECT_ID }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: "â€‹ðŸŽ¯ Ready for Dev"
  
  branch_created:
    if: github.event_name == 'create' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Extract Issue Number from Branch Name
        id: extract
        run: |
          BRANCH_NAME=${{ github.event.ref }}
          if [[ "$BRANCH_NAME" =~ ([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          else
            echo "No issue number found in branch name."
          fi

      - name: Get Issue Node ID
        if: steps.extract.outputs.issue_number != ''
        id: get_node
        uses: octokit/graphql-action@v2.x
        with:
          headers: '{"Authorization": "Bearer ${{ secrets.PROJECT_PAT) }}"}'
          query: |
            query($owner:String!, $repo:String!, $number:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$number) {
                  id
                }
              }
            }
          variables: |
            owner: ${{ github.repository_owner }}
            repo: ${{ github.event.repository.name }}
            number: ${{ fromJson(steps.extract.outputs.issue_number) }}

      - name: Move Issue to In Progress
        if: steps.extract.outputs.issue_number != ''
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_PAT) }}
          organization: ${{ env.ORGANIZATION }}
          project_id: ${{ env.PROJECT_ID }}
          resource_node_id: ${{ fromJson(steps.get_node.outputs.data).repository.issue.id }}
          status_value: "ðŸ”¨ In Progress"

  pr_opened:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Move PR to Code Review
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_PAT) }}
          organization: ${{ env.ORGANIZATION }}
          project_id: ${{ env.PROJECT_ID }}
          resource_node_id: ${{ github.event.pull_request.node_id }}
          status_value: "ðŸ‘€ Code Review / QA"

  pr_done:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Move PR to Done
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_PAT)}}
          organization: ${{ env.ORGANIZATION }}
          project_id: ${{ env.PROJECT_ID }}
          resource_node_id: ${{ github.event.pull_request.node_id }}
          status_value: "âœ… Done"
